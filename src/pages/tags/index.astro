---
import TagView from "@/components/content/TagView";
import { getBlogs, getLogs, getSnacks, getTags } from "@/utils/server/content";
import StarLayout from "@/layouts/StarLayout.astro";
import type { ImageMetadata } from "astro";
import { getImage } from "astro:assets";

// Redirect query parameter URLs to clean URLs
const tagParam = Astro.url.searchParams.get('tag');
if (tagParam) {
  return Astro.redirect(`/tags/${tagParam}/`, 301);
}

// Get search query parameter for Google search integration
const searchQuery = Astro.url.searchParams.get('q') || '';

const blogs = await getBlogs();
const logs = await getLogs();
const snacks = await getSnacks();

const tags = getTags(blogs, logs, snacks);

// Preprocess images for blogs and logs
const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/**/*.{jpeg,jpg,png,gif,webp,avif}"
);

async function preprocessBlogImage(blog: typeof blogs[0]) {
  if (!blog.data.image || blog.data.image.trim() === "") return null;
  
  try {
    const imageData = images[blog.data.image]?.();
    if (!imageData) return null;
    const optimized = await getImage({
      src: imageData,
      width: 800,
      height: 400,
    });
    return optimized.src;
  } catch {
    return null;
  }
}

async function preprocessLogImage(log: typeof logs[0]) {
  if (!log.data.image || log.data.image.trim() === "") return null;
  
  try {
    const imageData = images[log.data.image]?.();
    if (!imageData) return null;
    const optimized = await getImage({
      src: imageData,
      width: 800,
      height: 400,
    });
    return optimized.src;
  } catch {
    return null;
  }
}

// Preprocess all images
const blogsWithImages = await Promise.all(
  blogs.map(async (blog) => ({
    ...blog,
    _imageUrl: await preprocessBlogImage(blog),
  }))
);

const logsWithImages = await Promise.all(
  logs.map(async (log) => ({
    ...log,
    _imageUrl: await preprocessLogImage(log),
  }))
);

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": Astro.site
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Tags",
      "item": new URL("/tags/", Astro.site).href
    }
  ]
};
---

<StarLayout
  title="Tags"
  description="List of all tags that are in blogs, logs, and snacks"
>
  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(breadcrumbSchema)}
  />
  <TagView tags={tags} blogs={blogsWithImages} logs={logsWithImages} snacks={snacks} initialSearchQuery={searchQuery} client:load />
</StarLayout>
