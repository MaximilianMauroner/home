---
import TagView from "@/components/TagView";
import { getBlogs, getLogs, getSnacks, getTags } from "@/utils/server/content";
import StarLayout from "@/layouts/StarLayout.astro";
import type { ImageMetadata } from "astro";
import { getImage } from "astro:assets";

// Redirect query parameter URLs to clean URLs
const tagParam = Astro.url.searchParams.get('tag');
if (tagParam) {
  return Astro.redirect(`/tags/${tagParam}/`, 301);
}

const blogs = await getBlogs();
const logs = await getLogs();
const snacks = await getSnacks();

const tags = getTags(blogs, logs, snacks);

// Preprocess images for blogs and logs
const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/**/*.{jpeg,jpg,png,gif,webp,avif}"
);

async function preprocessBlogImage(blog: typeof blogs[0]) {
  if (!blog.data.image || blog.data.image.trim() === "") return null;
  
  try {
    const imageData = images[blog.data.image]?.();
    if (!imageData) return null;
    const optimized = await getImage({
      src: imageData,
      width: 800,
      height: 400,
    });
    return optimized.src;
  } catch {
    return null;
  }
}

async function preprocessLogImage(log: typeof logs[0]) {
  if (!log.data.image || log.data.image.trim() === "") return null;
  
  try {
    const imageData = images[log.data.image]?.();
    if (!imageData) return null;
    const optimized = await getImage({
      src: imageData,
      width: 800,
      height: 400,
    });
    return optimized.src;
  } catch {
    return null;
  }
}

// Preprocess all images
const blogsWithImages = await Promise.all(
  blogs.map(async (blog) => ({
    ...blog,
    _imageUrl: await preprocessBlogImage(blog),
  }))
);

const logsWithImages = await Promise.all(
  logs.map(async (log) => ({
    ...log,
    _imageUrl: await preprocessLogImage(log),
  }))
);
---

<StarLayout
  title="Tags"
  description="List of all tags that are in blogs, logs, and snacks"
>
  <TagView tags={tags} blogs={blogsWithImages} logs={logsWithImages} snacks={snacks} client:load />
</StarLayout>
