---
import FontmatterTagsList from "@/components/content/FontmatterTagsList.astro";
import PostImageLoader from "@/components/content/PostImageLoader.astro";
import TableOfContents from "@/components/content/TableOfContents";
import { type HeadingType } from "@/utils/types";
import { timeAgo } from "@/utils/helpers";
import StarLayout from "./StarLayout.astro";

interface Props {
  frontmatter: {
    title: string;
    description?: string;
    tags?: string[];
    releaseDate: Date | string;
    image?: string;
    lastModified?: string;
  };
  headings?: HeadingType[];
}

const { frontmatter, headings = [] } = Astro.props;

// Calculate article modified time - use lastModified if available, otherwise use releaseDate
const articleModifiedTime = frontmatter.lastModified
  ? new Date(frontmatter.lastModified).toISOString()
  : new Date(frontmatter.releaseDate).toISOString();

// Generate dynamic color scheme based on title
const colorSchemeIndex =
  parseInt(Astro.url.pathname.split("/blog/")[1].split("-")[0]) % 6 || 0;
const schemes = [
  {
    gradient: "from-violet-500/20 via-purple-500/20 to-fuchsia-500/20",
    darkGradient:
      "dark:from-violet-500/30 dark:via-purple-500/30 dark:to-fuchsia-500/30",
    accent: "text-violet-600 dark:text-violet-400",
    borderGradient: "from-violet-500/50 to-purple-500/50",
  },
  {
    gradient: "from-blue-500/20 via-cyan-500/20 to-teal-500/20",
    darkGradient:
      "dark:from-blue-500/30 dark:via-cyan-500/30 dark:to-teal-500/30",
    accent: "text-blue-600 dark:text-blue-400",
    borderGradient: "from-blue-500/50 to-cyan-500/50",
  },
  {
    gradient: "from-emerald-500/20 via-green-500/20 to-teal-500/20",
    darkGradient:
      "dark:from-emerald-500/30 dark:via-green-500/30 dark:to-teal-500/30",
    accent: "text-emerald-600 dark:text-emerald-400",
    borderGradient: "from-emerald-500/50 to-green-500/50",
  },
  {
    gradient: "from-rose-500/20 via-pink-500/20 to-fuchsia-500/20",
    darkGradient:
      "dark:from-rose-500/30 dark:via-pink-500/30 dark:to-fuchsia-500/30",
    accent: "text-rose-600 dark:text-rose-400",
    borderGradient: "from-rose-500/50 to-pink-500/50",
  },
  {
    gradient: "from-amber-500/20 via-orange-500/20 to-red-500/20",
    darkGradient:
      "dark:from-amber-500/30 dark:via-orange-500/30 dark:to-red-500/30",
    accent: "text-amber-600 dark:text-amber-400",
    borderGradient: "from-amber-500/50 to-orange-500/50",
  },
  {
    gradient: "from-indigo-500/20 via-blue-500/20 to-purple-500/20",
    darkGradient:
      "dark:from-indigo-500/30 dark:via-blue-500/30 dark:to-purple-500/30",
    accent: "text-indigo-600 dark:text-indigo-400",
    borderGradient: "from-indigo-500/50 to-blue-500/50",
  },
];
const scheme = schemes[colorSchemeIndex];
---

<StarLayout
  description={frontmatter.description || ""}
  title={frontmatter.title}
  image={frontmatter.image}
  articlePublishedTime={new Date(frontmatter.releaseDate).toISOString()}
  articleModifiedTime={articleModifiedTime}
  articleAuthor="Maximilian Mauroner"
>
  <div class="mx-auto max-w-5xl px-4 py-8 sm:px-6 lg:px-8 animate-fade-in">
    {/* Hero Header Section */}
    <header
      class="relative mb-12 overflow-hidden rounded-3xl border border-border/50 bg-card/80 backdrop-blur-xl sm:mb-16"
    >
      {/* Animated gradient background */}
      <div
        class={`absolute inset-0 bg-gradient-to-br ${scheme.gradient} ${scheme.darkGradient} opacity-50`}
        style={{
          backgroundSize: "200% 200%",
          animation: "animated-background 15s ease infinite",
        }}
      >
      </div>

      {/* Image overlay */}
      {
        frontmatter.image && (
          <div class="pointer-events-none absolute inset-0 overflow-hidden opacity-[0.15] dark:opacity-[0.08]">
            <PostImageLoader
              imagePath={frontmatter.image}
              altText={frontmatter.title}
              className="h-full w-full object-cover"
            />
            <div
              class="absolute inset-0 bg-gradient-to-br from-black/70 via-black/50 to-transparent dark:from-black/80 dark:via-black/60"
              style="pointer-events: none;"
            />
          </div>
        )
      }

      {/* Decorative grid */}
      <div
        class="absolute inset-0 opacity-[0.03] dark:opacity-[0.05]"
        style={{
          backgroundImage:
            "linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px)",
          backgroundSize: "30px 30px",
        }}
      >
      </div>

      <div class="relative z-10 p-8 sm:p-12 lg:p-16">
        {/* Tags */}
        {
          frontmatter.tags && frontmatter.tags.length > 0 && (
            <div
              class="mb-6 flex flex-wrap items-center gap-2 animate-fade-in"
              style="animation-delay: 100ms;"
            >
              <FontmatterTagsList tags={frontmatter.tags} />
            </div>
          )
        }

        {/* Date and metadata */}
        <div
          class="mb-4 flex flex-wrap items-center gap-4 text-sm animate-fade-in"
          style="animation-delay: 150ms;"
        >
          <div class={`font-medium uppercase tracking-wider ${scheme.accent}`}>
            {
              new Date(frontmatter.releaseDate).toLocaleDateString("en-US", {
                month: "long",
                day: "numeric",
                year: "numeric",
              })
            }
          </div>
          <div class="text-muted-foreground">â€¢</div>
          <div class="text-muted-foreground">
            {timeAgo(new Date(frontmatter.releaseDate))}
          </div>
        </div>

        {/* Title */}
        <h1
          class={`mb-6 text-4xl font-bold leading-tight text-foreground sm:text-5xl lg:text-6xl animate-fade-in`}
          style="animation-delay: 200ms;"
        >
          {frontmatter.title}
        </h1>

        {/* Description */}
        {
          frontmatter.description && (
            <p
              class="text-lg leading-relaxed text-muted-foreground sm:text-xl animate-fade-in"
              style="animation-delay: 250ms;"
            >
              {frontmatter.description}
            </p>
          )
        }
      </div>
    </header>

    {/* Main Content */}
    <article class="relative animate-fade-in" style="animation-delay: 300ms;">
      {/* Animated border accent */}
      <div
        class={`absolute -left-4 top-0 hidden h-full w-1 rounded-full bg-gradient-to-b ${scheme.borderGradient} opacity-50 lg:block`}
      >
      </div>

      {/* Content */}
      <div
        class="prose prose-lg prose-slate mx-auto max-w-none dark:prose-invert prose-headings:font-bold prose-headings:tracking-tight prose-h1:text-4xl prose-h2:text-3xl prose-h3:text-2xl dark:prose-headings:text-gray-100 prose-p:text-gray-700 dark:prose-p:text-gray-300 prose-p:leading-relaxed prose-strong:text-gray-900 dark:prose-strong:text-gray-100 prose-a:text-primary prose-a:no-underline hover:prose-a:underline dark:prose-a:text-blue-400 dark:hover:prose-a:text-blue-300 prose-code:rounded-md prose-code:bg-muted prose-code:px-1.5 prose-code:py-0.5 prose-code:text-sm prose-code:font-medium prose-code:text-foreground dark:prose-code:text-gray-200 prose-pre:bg-slate-900 dark:prose-pre:bg-slate-950 prose-pre:rounded-xl prose-li:text-gray-700 dark:prose-li:text-gray-300"
      >
        <slot />
      </div>
    </article>

    {
      headings.length > 0 && (
        <TableOfContents headingsArr={headings} client:idle />
      )
    }
  </div>
</StarLayout>
