---
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import type { ImageMetadata } from "astro";
import { getImage } from "astro:assets";
interface Props {
  title: string;
  description: string;
  image?: string;
  articlePublishedTime?: string;
  articleModifiedTime?: string;
  articleAuthor?: string;
}
const {
  title,
  description,
  image,
  articlePublishedTime,
  articleModifiedTime,
  articleAuthor,
} = Astro.props;
import "@/styles/globals.css";
import { ClientRouter } from "astro:transitions";
import Posthog from "@/components/layout/Posthog.astro";

// Normalize trailing slashes - ensure all URLs end with trailing slash (except root)
let normalizedPathname = Astro.url.pathname;
if (normalizedPathname !== "/" && !normalizedPathname.endsWith("/")) {
  normalizedPathname = normalizedPathname + "/";
}
const canonicalURL = new URL(normalizedPathname, Astro.site);
// Preserve query parameters for search pages (tags page with q parameter)
if (Astro.url.pathname === "/tags/" && Astro.url.searchParams.has("q")) {
  canonicalURL.search = Astro.url.search;
}

const images = import.meta.glob<{ default: ImageMetadata }>(
  "/src/assets/**/*.{jpeg,jpg,png,gif,webp,avif}"
);
let img;
if (image && images[image]) {
  img = await getImage({
    src: images[image](),
    width: 1024,
    height: 1024,
  });
} else {
  img = await getImage({
    src: "/astronaut.avif",
    width: 1024,
    height: 1024,
  });
}
---

<html lang="en">
  <>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="canonical" href={canonicalURL} />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(img.src, Astro.site)} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(img.src, Astro.site)} />

    <!-- Article Meta Tags -->
    {
      articlePublishedTime && (
        <>
          <meta
            property="article:published_time"
            content={articlePublishedTime}
          />
          <meta name="article:published_time" content={articlePublishedTime} />
        </>
      )
    }
    {
      articleModifiedTime && (
        <>
          <meta
            property="article:modified_time"
            content={articleModifiedTime}
          />
          <meta name="article:modified_time" content={articleModifiedTime} />
        </>
      )
    }
    {
      articleAuthor && (
        <>
          <meta property="article:author" content={articleAuthor} />
          <meta name="article:author" content={articleAuthor} />
        </>
      )
    }

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />

    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" />
    <meta name="generator" content={Astro.generator} />
    <!-- Robots meta tag -->
    {
      Astro.url.pathname.startsWith("/admin") ||
      Astro.url.pathname === "/404" ? (
        <meta name="robots" content="noindex, nofollow" />
      ) : (
        <meta name="robots" content="index, follow" />
      )
    }
    <ClientRouter />
    {import.meta.env.PROD && <Posthog />}

    <!-- Website Schema for Sitelinks Optimization -->
    {
      Astro.url.pathname === "/" && (
        <script
          is:inline
          type="application/ld+json"
          set:html={JSON.stringify({
            "@context": "https://schema.org",
            "@type": "WebSite",
            name: "Maximilian Mauroner",
            url: Astro.site,
            description:
              "Just a dev sharing cool stuff: code snippets that work, dev stories that might help, and random tech tools I think are neat.",
            publisher: {
              "@type": "Person",
              name: "Maximilian Mauroner",
              url: Astro.site,
            },
            potentialAction: {
              "@type": "SearchAction",
              target: {
                "@type": "EntryPoint",
                urlTemplate: `${Astro.site}/tags/?q={search_term_string}`,
              },
              "query-input": "required name=search_term_string",
            },
            mainEntity: {
              "@type": "ItemList",
              itemListElement: [
                {
                  "@type": "ListItem",
                  position: 1,
                  name: "Dev Log",
                  url: `${Astro.site}/dev-log/`,
                  description: "Development logs and updates",
                },
                {
                  "@type": "ListItem",
                  position: 2,
                  name: "Blog",
                  url: `${Astro.site}/blog/`,
                  description: "Blog posts about development and technology",
                },
                {
                  "@type": "ListItem",
                  position: 3,
                  name: "Snacks",
                  url: `${Astro.site}/snacks/`,
                  description: "Quick tips and code snippets",
                },
                {
                  "@type": "ListItem",
                  position: 4,
                  name: "Tools",
                  url: `${Astro.site}/tools/`,
                  description: "Interactive tools and utilities",
                },
                {
                  "@type": "ListItem",
                  position: 5,
                  name: "Tags",
                  url: `${Astro.site}/tags/`,
                  description: "Browse content by tags",
                },
              ],
            },
          })}
        />
      )
    }

    <script is:inline>
      const toggleDarkMode = (darkMode) => {
        document.documentElement.classList.toggle("dark", darkMode);
        localStorage.setItem("theme", darkMode ? "dark" : "light");
      };
      const storedTheme = localStorage.getItem("theme");

      if (storedTheme) {
        toggleDarkMode(storedTheme);
      } else {
        const systemDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        toggleDarkMode(systemDark ? "dark" : "light");
      }
      document.addEventListener("astro:after-swap", () => {
        const storedTheme = localStorage.getItem("theme");
        if (storedTheme) {
          toggleDarkMode(storedTheme);
        }
      });
    </script>
  </>
  <body lang="en" class="flex min-h-dvh flex-col">
    <Header />
    <main
      class="flex-1"
      transition:name="page-content"
      transition:animate="fade"
    >
      <slot />
    </main>
    <Footer />
  </body>
</html>
